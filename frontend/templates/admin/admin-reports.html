<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Infinity Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8c25f4',
                        dark: '#191022'
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400;
        }

        body {
            font-family: 'Spline Sans', sans-serif;
        }
    </style>
</head>

<body class="bg-dark font-display text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-[#1a1023] p-4 flex flex-col justify-between border-r border-white/10">
            <div class="flex flex-col gap-8">
                <div class="flex items-center gap-3 px-2">
                    <img id="sidebarAdminImg" src="https://i.pravatar.cc/40?img=15" alt="Admin" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h1 id="sidebarAdminName" class="text-white text-base font-medium">Infinity Events</h1>
                        <p class="text-purple-300 text-sm">Admin Panel</p>
                    </div>
                </div>
                <nav class="flex flex-col gap-2">
                    <a href="admin-dashboard.html"
                        class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                        <span class="material-symbols-outlined">dashboard</span>
                        <p class="text-sm font-medium">Dashboard</p>
                    </a>
                    <a href="admin-events.html"
                        class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                        <span class="material-symbols-outlined">event</span>
                        <p class="text-sm font-medium">Events</p>
                    </a>
                    <a href="admin-users.html"
                        class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                        <span class="material-symbols-outlined">group</span>
                        <p class="text-sm font-medium">Users</p>
                    </a>
                    <a href="admin-tickets.html"
                        class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                        <span class="material-symbols-outlined">confirmation_number</span>
                        <p class="text-sm font-medium">Tickets</p>
                    </a>
                    <a href="admin-reports.html"
                        class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                        <span class="material-symbols-outlined">bar_chart</span>
                        <p class="text-sm font-medium">Reports</p>
                    </a>
                    <a href="admin-settings.html"
                        class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                        <span class="material-symbols-outlined">settings</span>
                        <p class="text-sm font-medium">Settings</p>
                    </a>
                </nav>
            </div>
            <div class="flex flex-col gap-2">
                <a href="admin-support.html"
                    class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                    <span class="material-symbols-outlined">help_outline</span>
                    <p class="text-sm font-medium">Support</p>
                </a>
                <a href="index.html"
                    class="flex items-center gap-3 px-3 py-2 text-white/70 hover:bg-primary/20 hover:text-white rounded-lg transition">
                    <span class="material-symbols-outlined">logout</span>
                    <p class="text-sm font-medium">Logout</p>
                </a>
            </div>
        </aside>

        <main class="flex-1 flex flex-col">
            <div class="py-3 px-8 flex items-center justify-between border-b border-[#362249] bg-[#1a1023]">
                <h2 class="text-white text-lg font-bold">Reports</h2>
                <img id="headerAdminImg" src="https://i.pravatar.cc/40?img=15" alt="User" class="w-10 h-10 rounded-full object-cover">
            </div>
            <div class="p-8 max-w-7xl mx-auto">
            <!-- Page Heading -->
            <div class="flex justify-between items-center mb-6">
                <p class="text-4xl font-black">Reports</p>
                <div class="flex items-center gap-2">
                    <button
                        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 border border-white/20 hover:bg-white/20 transition">
                        <span class="material-symbols-outlined text-xl">calendar_today</span>
                        <span>Last 30 Days</span>
                        <span class="material-symbols-outlined text-xl">arrow_drop_down</span>
                    </button>
                    <button
                        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 border border-white/20 hover:bg-white/20 transition">
                        <span class="material-symbols-outlined text-xl">tune</span>
                        <span>Filters</span>
                    </button>
                    <button
                        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition">
                        <span class="material-symbols-outlined text-xl">download</span>
                        <span>Export All</span>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white/10 backdrop-blur border border-white/20 rounded-xl p-6">
                    <p class="text-white/70 text-base font-medium mb-2">Total Revenue</p>
                    <p class="text-3xl font-bold mb-2" id="totalRevenue">...</p>
                    <p class="text-green-400 text-sm font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-base">calendar_today</span>Last 30 days
                    </p>
                </div>
                <div class="bg-white/10 backdrop-blur border border-white/20 rounded-xl p-6">
                    <p class="text-white/70 text-base font-medium mb-2">Tickets Sold</p>
                    <p class="text-3xl font-bold mb-2" id="ticketsSold">...</p>
                    <p class="text-green-400 text-sm font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-base">calendar_today</span>Last 30 days
                    </p>
                </div>
                <div class="bg-white/10 backdrop-blur border border-white/20 rounded-xl p-6">
                    <p class="text-white/70 text-base font-medium mb-2">New Users</p>
                    <p class="text-3xl font-bold mb-2" id="newUsers">...</p>
                    <p class="text-green-400 text-sm font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-base">calendar_today</span>Last 30 days
                    </p>
                </div>
                <div class="bg-white/10 backdrop-blur border border-white/20 rounded-xl p-6">
                    <p class="text-white/70 text-base font-medium mb-2">Open Support Tickets</p>
                    <p class="text-3xl font-bold mb-2" id="openSupport">...</p>
                    <p class="text-orange-400 text-sm font-medium flex items-center gap-1">
                        <span class="material-symbols-outlined text-base">info</span>All Time
                    </p>
                </div>
            </div>

            <!-- Event Performance -->
            <div class="bg-white/10 backdrop-blur border border-white/20 rounded-xl p-6">
                <p class="text-lg font-medium mb-2">Top Selling Events</p>
                <div class="flex gap-2 items-center mb-4">
                    <p class="text-white/60 text-sm">Last 30 Days</p>
                </div>
                <div class="grid grid-flow-col gap-6 items-end justify-items-center h-56" id="eventChartContainer">
                    <p class="text-white/50 col-span-full self-center">Loading chart...</p>
                </div>
            </div>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white/10 backdrop-blur border border-white/20 rounded-xl overflow-hidden mt-8">
        <div class="p-6">
            <h3 class="text-lg font-medium mb-1">Recent Transactions</h3>
            <p class="text-white/60 text-sm">A list of the most recent ticket purchases (Completed).</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-black/30">
                    <tr>
                        <th class="p-4 font-semibold text-sm text-white/80">ID</th>
                        <th class="p-4 font-semibold text-sm text-white/80">User</th>
                        <th class="p-4 font-semibold text-sm text-white/80">Event</th>
                        <th class="p-4 font-semibold text-sm text-white/80">Date</th>
                        <th class="p-4 font-semibold text-sm text-white/80">Amount</th>
                        <th class="p-4 font-semibold text-sm text-white/80 text-center">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10" id="transactionsBody">
                    <tr>
                        <td colspan="6" class="p-4 text-center text-white/50">Loading transactions...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';

        async function loadReports() {
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            if (!token) {
                console.error('No token found, redirecting to login');
                window.location.href = 'admin_login.html';
                return;
            }

            try {
                // Fetch Last 30 Days by default
                console.log('Fetching reports from:', `${API_BASE_URL}/admin/reports?days=30`);
                const res = await fetch(`${API_BASE_URL}/admin/reports?days=30`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error Response:', res.status, errorText);
                    throw new Error(`Failed to fetch reports: ${res.status}`);
                }
                const data = await res.json();
                console.log('Reports data loaded:', data);

                updateUI(data);

            } catch (error) {
                console.error('Error loading reports:', error);
                // Set error values
                document.getElementById('totalRevenue').textContent = 'Error';
                document.getElementById('ticketsSold').textContent = 'Error';
                document.getElementById('newUsers').textContent = 'Error';
                document.getElementById('openSupport').textContent = 'Error';
                
                const chartContainer = document.getElementById('eventChartContainer');
                chartContainer.innerHTML = `<p class="text-red-400 col-span-full self-center">Error loading data: ${error.message}</p>`;
                
                const tbody = document.getElementById('transactionsBody');
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-400">Error loading transactions: ${error.message}</td></tr>`;
            }
        }

        function updateUI(data) {
            // Stats
            document.getElementById('totalRevenue').textContent = `Rs ${(data.revenue || 0).toLocaleString()}`;
            document.getElementById('ticketsSold').textContent = (data.tickets_sold || 0).toLocaleString();
            document.getElementById('newUsers').textContent = (data.new_users || 0).toLocaleString();
            document.getElementById('openSupport').textContent = (data.open_support || 0).toLocaleString();

            // Chart
            const chartContainer = document.getElementById('eventChartContainer');
            if (!data.chart_data || data.chart_data.length === 0) {
                chartContainer.innerHTML = '<p class="text-white/50 col-span-full self-center">No sales data for this period.</p>';
            } else {
                chartContainer.innerHTML = data.chart_data.map(item => `
                    <div class="flex flex-col items-center gap-2 group relative w-16">
                        <div class="absolute -top-8 bg-white text-black text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-10">
                            ${item.value} tickets
                        </div>
                        <div class="bg-primary/70 rounded-t w-full hover:bg-primary transition" style="height: ${item.percent}%"></div>
                        <p class="text-white/60 text-xs font-bold truncate w-full text-center" title="${item.label}">${item.label}</p>
                    </div>
                `).join('');
            }

            // Transactions
            const tbody = document.getElementById('transactionsBody');
            if (!data.transactions || data.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-white/50">No recent transactions.</td></tr>';
            } else {
                tbody.innerHTML = data.transactions.map(tx => `
                    <tr class="hover:bg-white/5">
                        <td class="p-4 text-sm font-mono text-white/70">#${tx.id}</td>
                        <td class="p-4 text-sm">${tx.user_name || 'Unknown'}</td>
                        <td class="p-4 text-sm">${tx.event_title || 'Unknown'}</td>
                        <td class="p-4 text-sm text-white/60">${new Date(tx.date).toLocaleDateString()}</td>
                        <td class="p-4 text-sm font-medium">Rs ${(tx.amount || 0).toLocaleString()}</td>
                        <td class="p-4 text-sm text-center">
                            <span class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900/50 text-green-300">
                                ${tx.status || 'COMPLETED'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, calling loadReports');
            loadReports();
        });
    </script>
    <script src="../../static/js/admin_profile.js"></script>

</html>